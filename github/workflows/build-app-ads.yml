name: Build app-ads.txt

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate app-ads.txt from /networks
        run: |
          echo "# ==================================================" > app-ads.txt
          echo "# AUTO-GENERATED app-ads.txt" >> app-ads.txt
          echo "# DO NOT EDIT THIS FILE DIRECTLY" >> app-ads.txt
          echo "# Edit files inside /networks/ and push to main." >> app-ads.txt
          echo "# ==================================================" >> app-ads.txt
          echo "" >> app-ads.txt

          # Loop over all network files in alphabetical order
          for file in $(ls networks/*.txt | sort); do
            name=$(basename "$file" .txt)

            echo "" >> app-ads.txt
            echo "# ==================================================" >> app-ads.txt
            echo "# NETWORK: ${name^^}" >> app-ads.txt
            echo "# SOURCE FILE: $file" >> app-ads.txt
            echo "# ==================================================" >> app-ads.txt
            echo "" >> app-ads.txt

            cat "$file" >> app-ads.txt
            echo "" >> app-ads.txt
          done

      - name: Remove duplicate lines (except comments)
        run: |
          # Keep comments + blank lines as is, dedupe only real entries
          awk '
            /^$/ { print; next }        # keep empty lines
            /^#/ { print; next }       # keep comments
            !seen[$0]++                # print non-duplicate data lines
          ' app-ads.txt > app-ads-clean.txt

          mv app-ads-clean.txt app-ads.txt

      - name: Commit changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add app-ads.txt
          git commit -m "Update auto-generated app-ads.txt" || echo "No changes to commit"
          git push || echo "No changes to push"
